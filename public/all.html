<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î | Shawty Shop</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"/>
</head>

<body>
  <!-- üîπ Navbar -->
  <header class="navbar">
    <div class="navbar-top">
      <div class="logo">
        <img src="../assets/image/star icon.jpg" alt="logo">
        <h1>Shawty Shop</h1>
      </div>

      <div class="nav-icons">
        <a id="cart-btn" class="cart-icon">
          <i class="bi bi-cart3"></i>
          <span id="cart-count">0</span>
        </a>
        <a id="profile-link" class="profile-icon">
          <i class="bi bi-person-circle"></i>
        </a>
      </div>
    </div>

    <nav class="navbar-bottom">
      <a href="index.html">HOME</a>
      <a href="all.html" class="active">ALL</a>
    </nav>
  </header>

  <!-- üîπ Section: ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
  <main class="container">
    <h1 class="section-title">ALL</h1>
    <div id="product-grid" class="product-grid"></div>
  </main>

  
  <!-- üîπ Popup ‡∏£‡∏ñ‡πÄ‡∏Ç‡πá‡∏ô -->
  <div id="cart-popup" class="cart-popup hidden">
    <div class="cart-content">
      <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà *‡∏ô‡∏≠‡∏Å* h2 -->
      <button id="close-cart" class="close-btn">&times;</button>
      
      <h2>‡∏£‡∏ñ‡πÄ‡∏Ç‡πá‡∏ô</h2>
      <div id="cart-items" class="cart-items"></div>
      
      <div class="cart-buttons">
        <button id="checkout-btn" class="btn black">‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
        <button id="clear-cart" class="btn red">‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏ñ‡πÄ‡∏Ç‡πá‡∏ô</button>
      </div>
    </div>
  </div>


  <!-- üîπ Toast -->
  <div id="toast" class="toast"></div>

  <script>
    // ===== Helper functions =====
    const toast = document.getElementById("toast");
    const grid = document.getElementById("product-grid");
    const cartPopup = document.getElementById("cart-popup");
    const cartItemsContainer = document.getElementById("cart-items");
    const cartCount = document.getElementById("cart-count");

    function showToast(msg) {
      toast.textContent = msg;
      toast.style.opacity = "1";
      setTimeout(() => (toast.style.opacity = "0"), 1500);
    }

    function getUsername() {
      return localStorage.getItem("username") || "guest";
    }

    function getCart() {
      return JSON.parse(localStorage.getItem(`cart_${getUsername()}`)) || [];
    }

    function saveCart(cart) {
      localStorage.setItem(`cart_${getUsername()}`, JSON.stringify(cart));
    }

    function updateCartCount() {
      const cart = getCart();
      const totalQty = cart.reduce((sum, i) => sum + i.quantity, 0);
      cartCount.textContent = totalQty;
    }

    // ===== ‡∏î‡∏∂‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ =====
    function getProducts() {
      return JSON.parse(localStorage.getItem("products")) || [];
    }

    // ===== ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ =====
    function renderProducts() {
      const all = getProducts();
      const products = all.filter(p => p.page === "all" || p.page === "both");

      if (products.length === 0) {
        grid.innerHTML = `<p class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>`;
        return;
      }

      grid.innerHTML = products.map((p, i) => `
        <div class="product-card">
          ${p.tag === "hot" ? `<div class='tag hot'>Hot</div>` : ""}
          ${p.tag === "new" ? `<div class='tag new'>New</div>` : ""}
          <img src="${p.image}" alt="${p.name}">
          <div class="product-info">
            <h2>${p.name}</h2>
            <p class="price">‡∏ø${p.price}</p>
            <p class="status ${
              p.status === "‡∏´‡∏°‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å" ? "red" :
              p.status === "‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤" ? "yellow" : "green"
            }">${p.status}</p>
            <button class="btn black add-btn" 
              ${p.status === "‡∏´‡∏°‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å" ? "disabled style='opacity:0.5;cursor:not-allowed;'" : ""} 
              data-index="${i}">
              ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏£‡∏ñ‡πÄ‡∏Ç‡πá‡∏ô
            </button>
          </div>
        </div>
      `).join("");

      document.querySelectorAll(".add-btn").forEach(btn => {
        btn.addEventListener("click", e => addToCart(products[e.target.dataset.index]));
      });
    }

    // ===== ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏£‡∏ñ‡πÄ‡∏Ç‡πá‡∏ô =====
    function addToCart(product) {
      const isLoggedIn = localStorage.getItem("isLoggedIn");
      if (isLoggedIn !== "true") {
        showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤");
        setTimeout(() => (window.location.href = "login.html"), 1200);
        return;
      }

      const cart = getCart();
      const exist = cart.find(i => i.name === product.name);
      if (exist) exist.quantity++;
      else cart.push({ name: product.name, price: product.price, quantity: 1 });

      saveCart(cart);
      updateCartCount();
      showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏° "${product.name}" ‡∏•‡∏á‡πÉ‡∏ô‡∏£‡∏ñ‡πÄ‡∏Ç‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß`);
    }

    // ===== Popup ‡∏£‡∏ñ‡πÄ‡∏Ç‡πá‡∏ô =====
    document.getElementById("cart-btn").addEventListener("click", () => {
      cartPopup.classList.remove("hidden");
      renderCart();
    });
    document.getElementById("close-cart").addEventListener("click", () => cartPopup.classList.add("hidden"));

    // ===== ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏ñ‡πÄ‡∏Ç‡πá‡∏ô =====
    function renderCart() {
      const cart = getCart();
      if (cart.length === 0) {
        cartItemsContainer.innerHTML = `<p class='empty'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏ñ‡πÄ‡∏Ç‡πá‡∏ô</p>`;
        return;
      }

      cartItemsContainer.innerHTML = cart.map((item, index) => `
        <div class="cart-item">
          <div>
            <p>${item.name}</p>
            <p class="price">‡∏ø${item.price} √ó ${item.quantity}</p>
          </div>
          <div class="cart-controls">
            <button class="decrease" data-index="${index}">-</button>
            <button class="increase" data-index="${index}">+</button>
            <button class="remove" data-index="${index}"><i class="bi bi-trash"></i></button>
          </div>
        </div>
      `).join("");

      document.querySelectorAll(".remove").forEach(btn => {
        btn.addEventListener("click", e => {
          const idx = e.target.closest("button").dataset.index;
          const cart = getCart();
          cart.splice(idx, 1);
          saveCart(cart);
          renderCart();
          updateCartCount();
        });
      });

      document.querySelectorAll(".increase").forEach(btn => {
        btn.addEventListener("click", e => {
          const idx = e.target.dataset.index;
          const cart = getCart();
          cart[idx].quantity++;
          saveCart(cart);
          renderCart();
          updateCartCount();
        });
      });

      document.querySelectorAll(".decrease").forEach(btn => {
        btn.addEventListener("click", e => {
          const idx = e.target.dataset.index;
          const cart = getCart();
          if (cart[idx].quantity > 1) cart[idx].quantity--;
          else cart.splice(idx, 1);
          saveCart(cart);
          renderCart();
          updateCartCount();
        });
      });
    }

    document.getElementById("clear-cart").addEventListener("click", () => {
      localStorage.removeItem(`cart_${getUsername()}`);
      renderCart();
      updateCartCount();
      showToast("‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏ñ‡πÄ‡∏Ç‡πá‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
    });

    document.getElementById("checkout-btn").addEventListener("click", () => {
      const cart = getCart();
      if (cart.length === 0) return showToast("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏ñ‡πÄ‡∏Ç‡πá‡∏ô");
      window.location.href = "checkout.html";
    });

    // ===== ‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå =====
    document.getElementById("profile-link").addEventListener("click", () => {
      const isLoggedIn = localStorage.getItem("isLoggedIn");
      const role = localStorage.getItem("role");
      if (isLoggedIn === "true") {
        if (role === "admin") window.location.href = "admin.html";
        else window.location.href = "profile.html";
      } else window.location.href = "login.html";
    });

    renderProducts();
    updateCartCount();

  </script>
</body>
</html>
