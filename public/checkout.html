<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ | ‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤</title>
  <link rel="stylesheet" href="style.css">
</head>
<body class="checkout-page">

  <div class="checkout-box">
    <h1>üßæ ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h1>

    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
    <div id="checkout-list" class="checkout-list"></div>

    <!-- ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏° -->
    <div class="checkout-total">
      ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="total-price" class="price">‡∏ø0</span>
    </div>

    <!-- ‡∏õ‡∏∏‡πà‡∏° -->
    <div class="checkout-buttons">
      <button id="back-btn" class="btn gray">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
      <button id="confirm-btn" class="btn black">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <script>
    // ===== Utility =====
    const toast = document.getElementById("toast");

    function showToast(msg) {
      toast.textContent = msg;
      toast.style.opacity = "1";
      setTimeout(() => (toast.style.opacity = "0"), 1500);
    }

    function getUsername() {
      return localStorage.getItem("username") || "guest";
    }

    function getCart() {
      const username = getUsername();
      return JSON.parse(localStorage.getItem(`cart_${username}`)) || [];
    }

    function clearCart() {
      const username = getUsername();
      localStorage.removeItem(`cart_${username}`);
    }

    // ===== ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ checkout =====
    const checkoutList = document.getElementById("checkout-list");
    const totalPriceEl = document.getElementById("total-price");

    function renderCheckout() {
      const username = getUsername();
      const address = localStorage.getItem(`address_${username}`);

      if (!address || address.trim() === "") {
        showToast("‚ö† ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠");
        return;
      }

      const cart = getCart();
      if (cart.length === 0) {
        checkoutList.innerHTML = `<p class="empty">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏ñ‡πÄ‡∏Ç‡πá‡∏ô</p>`;
        totalPriceEl.textContent = "‡∏ø0";
        return;
      }

      let total = 0;
      checkoutList.innerHTML = cart.map(item => {
        const itemTotal = item.price * item.quantity;
        total += itemTotal;
        return `
          <div class="checkout-item">
            <div>
              <p class="item-name">${item.name}</p>
              <p class="item-detail">‡∏ø${item.price} √ó ${item.quantity}</p>
            </div>
            <p class="item-total">‡∏ø${itemTotal.toFixed(2)}</p>
          </div>
        `;
      }).join("");
      totalPriceEl.textContent = `‡∏ø${total.toFixed(2)}`;
    }

    document.getElementById("back-btn").addEventListener("click", () => {
      window.location.href = "index.html";
    });

    // ===== ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ =====
    document.getElementById("confirm-btn").addEventListener("click", () => {
      const username = getUsername();
      const address = localStorage.getItem(`address_${username}`);
      const cart = getCart();

      if (cart.length === 0) {
        showToast("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏ñ‡πÄ‡∏Ç‡πá‡∏ô");
        return;
      }
      if (!address || address.trim() === "") {
        showToast("‚ö† ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠");
        return;
      }

      const newOrder = {
        username,
        address,
        items: cart,
        status: "‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß",
        date: new Date().toLocaleString("th-TH")
      };

      // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
      const allOrders = JSON.parse(localStorage.getItem("allOrders")) || [];
      allOrders.push(newOrder);
      localStorage.setItem("allOrders", JSON.stringify(allOrders));
      
      clearCart();
      showToast("‚úÖ ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
      setTimeout(() => (window.location.href = "index.html"), 1000);
    });

    renderCheckout();
  </script>
</body>
</html>
