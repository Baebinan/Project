<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ | ‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤</title>
  <link rel="stylesheet" href="style.css">
</head>
<body class="checkout-page">

  <div class="checkout-box">
    <h1>üßæ ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h1>

    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
    <div id="checkout-list" class="checkout-list"></div>

    <!-- ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏° -->
    <div class="checkout-total">
      ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="total-price" class="price">‡∏ø0</span>
    </div>

    <!-- ‡∏õ‡∏∏‡πà‡∏° -->
    <div class="checkout-buttons">
      <button id="back-btn" class="btn gray">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
      <button id="confirm-btn" class="btn black">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <script>
    // ---------- Utils ----------
    const toast = document.getElementById("toast");
    const showToast = (msg) => { toast.textContent = msg; toast.classList.add("show"); setTimeout(()=>toast.classList.remove("show"), 1800); };

    // ‡∏≠‡πà‡∏≤‡∏ô user ‡∏à‡∏≤‡∏Å localStorage
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠");
      window.location.href = "login.html";
    }
    if (user && (user.role === "admin" || user.username === "admin")) {
      alert("‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ");
      window.location.href = "admin.html";
    }

    const checkoutList = document.getElementById("checkout-list");
    const totalPriceEl = document.getElementById("total-price");

    // ‡∏£‡∏±‡∏ö items ‡∏à‡∏≤‡∏Å checkoutItems (‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ‡∏ï‡∏≠‡∏ô‡∏Å‡∏î ‚Äú‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‚Äù ‡πÉ‡∏ô index)
    function getCheckoutItems() {
      let items = JSON.parse(localStorage.getItem("checkoutItems")) || [];
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ checkoutItems ‡πÉ‡∏´‡πâ fallback ‡πÑ‡∏õ cart
      if (!items.length) {
        items = JSON.parse(localStorage.getItem("cart")) || [];
      }
      // normalize: ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á qty ‡πÅ‡∏•‡∏∞ quantity
      return items.map(it => ({
        id: it.id,
        name: it.name,
        price: Number(it.price),
        quantity: it.quantity != null ? it.quantity : (it.qty != null ? it.qty : 1),
        image: it.image || ""
      }));
    }

    function setCheckoutItems(items) {
      localStorage.setItem("checkoutItems", JSON.stringify(items));
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    function renderCheckout() {
      const items = getCheckoutItems();

      if (!items.length) {
        checkoutList.innerHTML = `<p class="empty">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>`;
        totalPriceEl.textContent = "‡∏ø0.00";
        return;
      }

      let total = 0;
      checkoutList.innerHTML = items.map((item, idx) => {
        const sub = item.price * item.quantity;
        total += sub;
        return `
          <div class="checkout-item" data-index="${idx}">
            <div class="left">
              ${item.image ? `<img class="thumb" src="${item.image}" alt="${item.name}">` : ""}
              <div>
                <p class="item-name">${item.name}</p>
                <p class="item-detail">‡∏ø${item.price.toFixed(2)}</p>
              </div>
            </div>
            <div class="right">
              <button class="qty-btn dec" aria-label="decrease">‚àí</button>
              <span class="qty">${item.quantity}</span>
              <button class="qty-btn inc" aria-label="increase">+</button>
              <span class="item-total">‡∏ø${sub.toFixed(2)}</span>
            </div>
          </div>
        `;
      }).join("");

      totalPriceEl.textContent = `‡∏ø${total.toFixed(2)}`;
    }

    // ‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô +/-
    checkoutList.addEventListener("click", (e) => {
      const row = e.target.closest(".checkout-item");
      if (!row) return;
      const idx = Number(row.dataset.index);
      const items = getCheckoutItems();

      if (e.target.classList.contains("inc")) {
        items[idx].quantity += 1;
      }
      if (e.target.classList.contains("dec")) {
        items[idx].quantity -= 1;
        if (items[idx].quantity <= 0) items.splice(idx, 1);
      }
      setCheckoutItems(items);
      renderCheckout();
    });

    // ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
    document.getElementById("back-btn").addEventListener("click", () => {
      window.location.href = "index.html";
    });

    // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ ‚Üí ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å /place-order
    document.getElementById("confirm-btn").addEventListener("click", async () => {
      const items = getCheckoutItems();
      if (!items.length) {
        showToast("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠");
        return;
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô localStorage ‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ)
      const addressKey = `address_${user.username}`;
      const address = localStorage.getItem(addressKey) || "";
      if (!address.trim()) {
        showToast("‚ö† ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠");
        return;
      }

      try {
        // ‡πÅ‡∏õ‡∏•‡∏á items ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö server: { name, price }
        const payloadItems = items.map(i => ({ name: i.name, price: i.price }));

        const res = await fetch("http://localhost:3000/place-order", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username: user.username, items: payloadItems })
        });

        const data = await res.json();
        if (!res.ok) {
          showToast(data.message || "‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
          return;
        }

        // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏£‡∏ñ‡πÄ‡∏Ç‡πá‡∏ô/‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ï‡πå
        localStorage.removeItem("cart");
        localStorage.removeItem("checkoutItems");

        showToast("‚úÖ ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
        setTimeout(() => window.location.href = "index.html", 1000);
      } catch (err) {
        console.error(err);
        showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå");
      }
    });

    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
    renderCheckout();
  </script>
</body>
</html>
